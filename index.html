<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galactic Defender: Final Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style> 
        body { margin: 0; padding: 0; background: #000; overflow: hidden; user-select: none; -webkit-user-select: none; } 
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
            z-index: 999; cursor: pointer; color: #0f0; font-family: sans-serif; font-size: 30px; font-weight: bold;
            flex-direction: column;
        }
    </style>
</head>
<body>

<div id="start-overlay" onclick="startGame()">
    <div>TAP TO START</div>
    <div style="font-size: 15px; color: #fff; margin-top: 10px;">(Enable Sound System)</div>
</div>

<script>
// --- 1. AUDIO ENGINE (ROBUST) ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;
let gameStarted = false;

function initAudio() {
    if (!audioCtx) {
        audioCtx = new AudioContext();
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
}

// Hàm sinh âm thanh "giả lập" (Synth)
function sfx(type) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const now = audioCtx.currentTime;

    if (type === 'shoot') { // Tiếng pew pew
        osc.type = 'square';
        osc.frequency.setValueAtTime(300, now);
        osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.start(now);
        osc.stop(now + 0.1);
    } 
    else if (type === 'hit') { // Tiếng trúng đạn
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(150, now);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.05);
        osc.start(now);
        osc.stop(now + 0.05);
    }
    else if (type === 'explode') { // Tiếng nổ rầm
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, now);
        osc.frequency.exponentialRampToValueAtTime(10, now + 0.4);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
        osc.start(now);
        osc.stop(now + 0.4);
    }
    
    osc.connect(gain);
    gain.connect(audioCtx.destination);
}

function startGame() {
    initAudio(); // Kích hoạt âm thanh ngay khi bấm
    document.getElementById('start-overlay').style.display = 'none';
    gameStarted = true;
}

// --- 2. GAME CONFIG ---
const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    backgroundColor: '#000000',
    physics: { default: 'arcade', arcade: { debug: false, gravity: { y: 0 } } },
    scene: { preload: preload, create: create, update: update },
    scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH }
};

let player, bullets, enemies, enemyBullets, stars;
let score = 0, scoreText, waveText;
let currentWave = 1;
let waveTimeRemaining = 30;
let lastFired = 0;
let isWaveActive = false;
let spawnTimer, waveTimer;

const game = new Phaser.Game(config);

function preload() {
    // Không load ảnh, dùng code vẽ hình
}

function create() {
    // --- A. BACKGROUND STARFIELD (Vũ trụ) ---
    stars = [];
    for(let i=0; i<100; i++) {
        let star = this.add.circle(
            Phaser.Math.Between(0, config.width),
            Phaser.Math.Between(0, config.height),
            Phaser.Math.Between(1, 3), // Kích thước sao
            0xffffff
        );
        star.speed = Phaser.Math.Between(1, 5); // Tốc độ rơi
        stars.push(star);
    }

    // --- B. GROUPS ---
    bullets = this.physics.add.group();
    enemyBullets = this.physics.add.group();
    enemies = this.physics.add.group();

    // --- C. PLAYER (Tam giác) ---
    player = this.add.triangle(config.width/2, config.height-80, 0, -20, -15, 15, 15, 15, 0x00ff00);
    this.physics.add.existing(player);
    player.body.setCollideWorldBounds(true);
    player.body.setImmovable(true);
    player.body.setSize(20, 20);

    // --- D. UI ---
    scoreText = this.add.text(10, 10, 'SCORE: 0', { fontSize: '18px', fill: '#fff' }).setDepth(100);
    waveText = this.add.text(config.width/2, 50, '', { fontSize: '24px', fill: '#ffff00', fontStyle: 'bold' }).setOrigin(0.5).setDepth(100);

    // --- E. INPUT ---
    this.input.on('pointermove', (pointer) => {
        if(gameStarted && player.active) player.x = pointer.x;
    });

    // --- F. COLLISIONS ---
    this.physics.add.overlap(bullets, enemies, hitEnemy, null, this);
    this.physics.add.overlap(player, enemies, playerHit, null, this);
    this.physics.add.overlap(player, enemyBullets, playerHit, null, this);

    // Chờ bấm nút Start mới chạy logic game
}

function update(time, delta) {
    if (!gameStarted) return;

    // 1. Logic Background (Sao rơi)
    stars.forEach(star => {
        star.y += star.speed;
        if (star.y > config.height) {
            star.y = 0;
            star.x = Phaser.Math.Between(0, config.width);
        }
    });

    if (!player.active) return;
    if (!isWaveActive && currentWave === 1 && time > 1000 && !spawnTimer) startWave(this, 1);

    // 2. Logic Bắn Đạn (Rate 2.5 shots/s => 400ms interval)
    if (this.input.activePointer.isDown && time > lastFired && isWaveActive) {
        fireBullet(this);
        lastFired = time + 400; // 400ms delay = 2.5 viên/giây
    }

    // 3. Cleanup
    bullets.children.each(b => { if(b.y < -50) b.destroy(); });
    enemyBullets.children.each(b => { if(b.y > config.height + 50) b.destroy(); });
}

function fireBullet(scene) {
    // Đạn tròn nhỏ (Circle), màu vàng
    let b = scene.add.circle(player.x, player.y - 25, 5, 0xffff00);
    scene.physics.add.existing(b);
    bullets.add(b);
    b.body.setVelocityY(-600);
    sfx('shoot');
}

// --- LOGIC WAVE ---

function startWave(scene, wave) {
    currentWave = wave;
    isWaveActive = true;
    waveTimeRemaining = 30;
    
    waveText.setText('WAVE ' + wave);
    scene.tweens.add({targets: waveText, alpha: 0, duration: 2000, delay: 1000});

    if (waveTimer) waveTimer.remove();
    if (spawnTimer) spawnTimer.remove();

    // Spawn quái
    let delay = wave === 3 ? 2000 : (wave === 2 ? 800 : 1000);
    spawnTimer = scene.time.addEvent({ delay: delay, callback: () => spawnEnemy(scene), loop: true });

    // Đếm ngược 30s
    waveTimer = scene.time.addEvent({
        delay: 1000, repeat: 30,
        callback: () => {
            waveTimeRemaining--;
            if(waveTimeRemaining <= 0) endWave(scene);
        }
    });

    // Boss logic
    if(wave <= 2) scene.time.delayedCall(15000, () => spawnMob(scene, 'miniboss'));
    if(wave === 3) scene.time.delayedCall(2000, () => spawnMob(scene, 'boss'));
}

function endWave(scene) {
    if(currentWave < 3) {
        startWave(scene, currentWave + 1);
    }
}

function spawnEnemy(scene) {
    if(currentWave === 3) return; 
    spawnMob(scene, 'normal');
}

function spawnMob(scene, type) {
    let x = Phaser.Math.Between(30, config.width - 30);
    let mob;

    if (type === 'normal') {
        mob = scene.add.rectangle(x, -50, 30, 30, 0x00ffff);
        setupMob(scene, mob, 10, 100);
    } 
    else if (type === 'miniboss') {
        mob = scene.add.rectangle(config.width/2, -60, 60, 60, 0xffff00);
        setupMob(scene, mob, 50, 50);
        scene.tweens.add({targets: mob, angle: 360, duration: 2000, repeat: -1});
    }
    else if (type === 'boss') {
        mob = scene.add.rectangle(config.width/2, -100, 100, 100, 0xff0000);
        setupMob(scene, mob, 200, 20);
        mob.setRotation(Math.PI / 4);
        // Boss bắn trả
        scene.time.addEvent({
            delay: 1000, loop: true,
            callback: () => {
                if(!mob.active) return;
                let b = scene.add.circle(mob.x, mob.y, 8, 0xff0000);
                scene.physics.add.existing(b);
                enemyBullets.add(b);
                scene.physics.moveToObject(b, player, 200);
            }
        });
    }
}

function setupMob(scene, mob, hp, speed) {
    scene.physics.add.existing(mob);
    enemies.add(mob);
    mob.setData('hp', hp);
    mob.body.setVelocityY(speed);
}

// --- LOGIC CHIẾN ĐẤU & NỔ ---

function hitEnemy(bullet, enemy) {
    bullet.destroy();
    
    let hp = enemy.getData('hp') - 10;
    enemy.setData('hp', hp);
    
    if (hp > 0) {
        sfx('hit');
        enemy.setAlpha(0.5);
        enemy.scene.time.delayedCall(50, () => enemy.setAlpha(1));
    } else {
        sfx('explode');
        createExplosion(enemy.scene, enemy.x, enemy.y, enemy.fillColor);
        enemy.destroy();
        score += 10;
        scoreText.setText('SCORE: ' + score);
        
        if(enemy.width > 80) winGame(enemy.scene);
    }
}

function createExplosion(scene, x, y, color) {
    // Tạo 30 mảnh vỡ bay tung tóe
    for (let i = 0; i < 30; i++) {
        let size = Phaser.Math.Between(2, 6);
        let part = scene.add.rectangle(x, y, size, size, color);
        scene.physics.add.existing(part);
        
        // Vận tốc ngẫu nhiên theo mọi hướng
        let angle = Phaser.Math.Between(0, 360);
        let speed = Phaser.Math.Between(100, 300);
        scene.physics.velocityFromAngle(angle, speed, part.body.velocity);
        
        // Hiệu ứng xoay và mờ dần
        scene.tweens.add({
            targets: part,
            alpha: 0,
            angle: 360,
            scale: 0,
            duration: 600,
            onComplete: () => part.destroy()
        });
    }
}

function playerHit(player, obj) {
    obj.destroy();
    sfx('explode');
    createExplosion(player.scene, player.x, player.y, 0x00ff00);
    player.setActive(false).setVisible(false);
    
    // Màn hình Game Over
    let txt = player.scene.add.text(config.width/2, config.height/2, 'GAME OVER', {fontSize:'40px', color:'#f00'}).setOrigin(0.5);
    player.scene.input.once('pointerdown', () => location.reload());
}

function winGame(scene) {
    scene.physics.pause();
    scene.add.text(config.width/2, config.height/2, 'YOU WIN!', {fontSize:'50px', color:'#0f0'}).setOrigin(0.5);
    scene.input.once('pointerdown', () => location.reload());
}

</script>
</body>
</html>
